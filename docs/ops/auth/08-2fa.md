# Phase 8 — Two-Factor Authentication (2FA/TOTP)
- **Timestamp:** 2025-10-09 19:00 UTC
- **Environment:** DreamHost VPS (Nginx, PHP 8.2, MySQL)

## Current State
- Endpoints `/get2FAQRCode` and `/verify2FACode` exist but return stubbed JSON responses (`status: ok`). They do **not** integrate with a TOTP library yet.
- Database table `bf_user_2fa` provisioned via migration for encrypted secret storage, backup codes, and enable flag.
- Encryption key in `Config\\Encryption` is empty, preventing secure storage of TOTP secrets until set.

## Provisioning Requirements
1. Generate secret using Myth/Auth TOTP service or RobThree\Auth library.
2. Encrypt secret using configured key (AES-256-CTR). Store IV/tag fields from `bf_user_2fa` migration.
3. Produce QR code (PNG or data URI) with CSP allowances (`img-src 'self' data:`) and optionally deliver backup codes.

## Verification Requirements
- Compare submitted TOTP code with secret using constant-time comparison.
- Implement drift tolerance (±1 timestep) and rate limiting on verification attempts.
- Provide "remember device" cookie only when encryption key + secure cookie policy in place.

## Recovery / Backup Codes
- Migration includes `backup_codes_hashes`. Need to implement generation (e.g., 10 one-time codes hashed with bcrypt) and display/download workflow.

## CSP & Front-End Notes
- Add `'data:'` to `App::$CSPImgSrc` to allow inline QR images if using data URIs.
- If using external QR CDN, whitelist domain in CSP and ensure HTTPS.
- DashLite templates should surface nonce attributes if inline scripts needed to render QR using JS libraries.

## Outstanding Actions
1. Integrate actual TOTP service in controller, replacing stubs.
2. Build UI screens under `Auth/2fa_qrcode.php` and `Auth/2fa_verify.php` to guide users through setup.
3. Implement admin bypass or recovery workflow documented for support team.
4. Add automated tests covering 2FA enable/disable lifecycle once implemented.
